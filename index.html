<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>submarine</title>
    <style>
        body {
            background-color: #000000;
            margin: 0px;
        }
        canvas {
            background-color: #0099FF;
        }
    </style>
</head>

<body>
    <canvas id="canvas" width="1900" height="1500">
    </canvas>

    <script type="text/javascript">
        var canvas;
        var ctx;
        var canvasBuffer;
        var bufferCtx;
        var threadSpeed = 16;

        class obj{
            constructor(img, width, height){
                this.img = new Image();
                this.img.src = img;
                this.width = width;
                this.height = height;
                this.x = 0;
                this.y = 0;
            }

            drawObj() {
                bufferCtx.drawImage(this.img, this.x - this.width / 2, this.y - this.height / 2, this.width,  this.height);
            }
        }

        class lifeObj extends obj{
            constructor(img, width, height){
                super(img, width, height);
                this.vx = 0;
                this.vy = 0;
                this.maxSpeed = 5;
                this.speed = 1;
                this.level = 0;
            }

            uqdateXY(){
                this.x += this.vx;
                this.y += this.vy;
            }

            downSpeed(){
                if(this.vx > 0)  this.vx -= 1;
                else if(this.vx < 0)  this.vx += 1;

                if(this.vy > 0)  this.vy -= 1;
                else if(this.vy < 0)  this.vy += 1;
            }

            moveXY(vx, vy){
                this.vx += vx;
                this.vy += vy;

                if(this.vx > this.maxSpeed)  this.vx = this.maxSpeed;
                else if(this.vx < -this.maxSpeed)  this.vx = -this.maxSpeed;
                
                if(this.vy > this.maxSpeed)  this.vy = this.maxSpeed;
                else if(this.vy < -this.maxSpeed)  this.vy = -this.maxSpeed;
            }

            setMaxSpeed(maxSpeed){
                this.maxSpeed = maxSpeed;
            }

            setSpeed(speed){
                this.speed = speed;
            }

            getVX(){
                return this.vx;
            }

            getVY(){
                return this.vy;
            }

            setLevel(level){
                this.level = level;
            }
        }
        //배경이미지
        var background;

        //잠수함
        var submarine = new lifeObj(
            "image/player.png", 60, 30
        );
        submarine.setMaxSpeed(10);
        submarine.setSpeed(2);
        submarine.setLevel(0);

        //장애물
        var enemyCount = 10;
        const enemyFool = new Set();
        const enemyType = [
            { img:"image/fish_1.png", w: 60, h: 30, lv: 100, nLv: 0, ms: 20},
            { img:"image/fish_2.png", w: 80, h: 40, lv: 1, nLv: 1, ms: 15},
            { img:"image/fish_3.png", w: 120, h: 60, lv: 2, nLv: 2, ms: 15},
            { img:"image/fish_4.png", w: 180, h: 90, lv: 2, nLv: 3, ms: 10},
            { img:"image/fish_5.png", w: 300, h: 150, lv: 3, nLv: 4, ms: 10},
            { img:"image/fish_6.png", w: 540, h: 270, lv: 10, nLv: 5, ms: 5}];
        var ellapse = 10;

        //타이머 인스턴스
        var loopInstance;

        //게임의 상태
        var STATE_START = false;
        var STATE_GAMEOVER = false;

        //키 상태
        var keyPressed = [];

        //경과 시간
        var oldTime;
        var startTime;
        var totalTime;

        window.addEventListener("load", initialize, false);
        window.addEventListener("keydown", getKeyDown, false);
        window.addEventListener("keyup", getKeyUp, false);

        function initialize() {
            canvas = document.getElementById("canvas");
            if (canvas == null || canvas.getContext == null) return;
            ctx = canvas.getContext("2d");
            canvasBuffer = document.createElement("canvas");
            canvasBuffer.width = canvas.width;
            canvasBuffer.height = canvas.height;
            bufferCtx = canvasBuffer.getContext("2d");

            //이미지 설정
            setImage();
            //게임 시작 메시지
            startMessage();
            //타이머 동작
            loopInstance = setInterval(update, threadSpeed);
        }

        function startMessage() {
            drawText(ctx, "Enter to Start", canvas.width / 2, canvas.height / 2 - 60, "bold 30px arial", "#ffff00", "center", "top");
            drawText(ctx, "조작 : 방향키 ←↑→↓", canvas.width / 2, canvas.height / 2 - 20, "bold 20px arial", "#ffffff", "center", "top");
        }

        // 현재 시간 구함
        function getTime() {
            var date = new Date();
            var time = date.getTime();
            delete date;
            return time;
        }
        //주기적으로 반복되는 루틴
        function update() {
            // 플레이어 이동 키 감지
            movePlayer();

            if (keyPressed[32] == true) {
                document.location.reload();
                startGame();
            }
            if ((keyPressed[13] == true) && !STATE_START) //enter
            {
                startGame();
            }

            if(STATE_START){
                //장애물의 이동
                moveObstacle(ellapse);
                //캔버스 초기화
                clearAll();
                //캔버스에 그리기
                drawAll();
            }
        }

        function movePlayer(){ 

            if (keyPressed[38]) submarine.moveXY(0, -submarine.speed);
            if (keyPressed[40]) submarine.moveXY(0, submarine.speed);
            if (keyPressed[37]) submarine.moveXY(-submarine.speed, 0);
            if (keyPressed[39]) submarine.moveXY(submarine.speed, 0);

            // 플레이어 감속
            submarine.downSpeed();
            // 플레이어 위치 업데이트
            submarine.uqdateXY();
            // 맵과 충돌이 일어났는지 체크
            crashMap()
        }

        function crashMap(){
            var mx = canvas.width;
            var my = canvas.height;

            if (mx < submarine.x ) submarine.x = mx;
            if(submarine.x < 0) submarine.x = 0;
            if(my < submarine.y) submarine.y = my;
            if(submarine.y < 0) submarine.y = 0;
            
        }

        function clearAll(){
            canvasBuffer.width = canvasBuffer.width;
            canvas.width = canvas.width;
        }

        function moveObstacle(ellapse) {
            //장애물의 이동
            enemyFool.forEach(function (enemy) {
                // 장애물 위치 업데이트
                enemy.uqdateXY();
                // 장애물 사망
                deleteObstacle(enemy);
                // 장애물 생성
                createObstacle();
                //충돌 검사
                crashObstacle(enemy);
            });
        }
        function deleteObstacle(enemy){
            if ((enemy.x > canvas.width + enemy.width) || (enemy.x < -enemy.width)
            || (enemy.y > canvas.height + enemy.height) || (enemy.y < -enemy.height)) {
                enemyFool.delete(enemy);
            }
        }
        
        function crashObstacle(enemy) {
            var mx = enemy.x;
            var my = enemy.y;

            if (mx > submarine.x  - submarine.width / 2 
            && mx < submarine.x + submarine.width / 2
            && my > submarine.y - submarine.height / 2 
            && my < submarine.y + submarine.height / 2) {
                if(submarine.height >= enemy.height - 5){ // 먹었을 때

                    var sizeUp = enemyType[enemy.level];
                    submarine.width += sizeUp.lv * 2;
                    submarine.height += sizeUp.lv;

                    if(submarine.level < enemy.level-1){
                        submarine.level =  enemy.level-1;
                    }

                    enemyFool.delete(enemy);
                }
                else{
                    STATE_GAMEOVER = true;
                }
            }
        }



        function startGame() {
            //게임 시작 상태
            STATE_START = true;
            //캐릭터의 초기 위치
            submarine.x = canvas.width / 2 - 18;
            submarine.y = canvas.height / 2 - 18;

            //장애물 생성
            createObstacle();

            //현재 시간 저장
            startTime = getTime();
            oldTime = getTime();
        }

        // 장애물 생성
        function createObstacle() {
            var diff = enemyCount - enemyFool.size + (5 * submarine.level);
            
            for (var i = 0; i < diff; i++) {
                var isLR;
                if(Math.floor(Math.random() * 2) == 0) isLR = true;
                else isLR = false;

                var type = Math.floor(Math.random() * (4 + submarine.level) + submarine.level - 1);
                if(enemyType.length < type) type = enemyType.length-1;
                if(0 > type) type = 0;
                var enemyTmp = new lifeObj(enemyType[type].img, enemyType[type].w, enemyType[type].h);

                enemyTmp.setLevel(enemyType[type].nLv);
                enemyTmp.x = (isLR ? -enemyTmp.width : canvas.width + enemyTmp.width);
                enemyTmp.y = Math.random() * canvas.height;
                enemyTmp.setMaxSpeed(enemyType[type].ms);
                enemyTmp.setSpeed(Math.random() * 10 + 1);
                enemyTmp.moveXY((isLR ? enemyTmp.speed : -enemyTmp.speed), Math.random() * 3 - 1)
                enemyTmp.drawObj();
                
                enemyFool.add(enemyTmp);
            }
        }

        function stopGame() {
            STATE_START = false;
        }
        function setImage() {
            background = new Image();
            background.src = "image/sea.png";
        }

        function getKeyDown(event) {
            keyPressed[event.keyCode] = true;
        }

        function getKeyUp(event) {
            keyPressed[event.keyCode] = false;
        }

        function drawText(ctx, text, x, y, font, color, align, base) {
            if (font != undefined) ctx.font = font;
            if (color != undefined) ctx.fillStyle = color;
            if (align != undefined) ctx.textAlign = align;
            if (base != undefined) ctx.textBaseline = base;
            ctx.fillText(text, x, y);
        }
        function drawAll() {
            if (!STATE_START) {
                return;
            }
            else if (STATE_GAMEOVER) {
                stopGame();
                drawText(ctx, "Game Over", canvas.width / 2, canvas.height / 2 - 60, "bold 30px arial", "#ffff00", "center", "top");
                drawText(ctx, "Spacebar to Restart", canvas.width / 2, canvas.height / 2 - 20, "bold 25px arial", "#ffffff", "center", "top");
            }
            else {
                //배경 이미지 출력
                drawBk();
                //잠수함 출력
                submarine.drawObj();
                //장애물 출력
                drawObstacle();
                // 화면 갱신
                ctx.drawImage(canvasBuffer, 0, 0);
                //경과 시간 출력
                totalTime = (getTime() - startTime);
                drawText(ctx, totalTime, canvas.width - 10, 10, "20px arial", "yellow", "right", "top");
            }
        }
        //장애물 출력
        function drawObstacle() {
            enemyFool.forEach(function(enemy) {
                enemy.drawObj();
            });
        }

        //게임 배경 이미지 출력
        function drawBk() {
            bufferCtx.drawImage(background, 0, 0);
        }

        function a(val){
            console.log(val);
        }
    </script>
</body>

</html>